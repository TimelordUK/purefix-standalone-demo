name: Build and Run Demo

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build:
    name: Build and Run
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore tools and dependencies
      run: dotnet tool restore && dotnet restore

    - name: Build
      run: dotnet build --configuration Release

    - name: Run demo (quick test)
      run: |
        timeout 10 dotnet run --configuration Release --no-build -- reset || exit_code=$?
        # Exit code 124 means timeout (expected), anything else is a real error
        if [ "${exit_code:-0}" -eq 124 ]; then
          echo "Demo ran successfully (terminated by timeout as expected)"
          exit 0
        elif [ "${exit_code:-0}" -ne 0 ]; then
          echo "Demo failed with exit code $exit_code"
          exit $exit_code
        fi
